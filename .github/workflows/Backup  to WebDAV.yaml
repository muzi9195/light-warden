name: Backup D1 Database to WebDAV

on:
    schedule:
        # Run daily at UTC 04:00
        - cron: "0 4 * * *"
    workflow_dispatch:
        inputs:
            environment:
                description: "Select the environment to backup"
                required: true
                default: "production"
                type: choice
                options:
                    - production
                    - dev

jobs:
    backup:
        name: Backup Database
        runs-on: ubuntu-latest
        # ËøôÈáå‰∏çÂÜçÈúÄË¶Å if Âà§Êñ≠ÔºåÊàë‰ª¨ÈÄöËøáÂÜÖÈÉ®ÈÄªËæëÊéßÂà∂
        steps:
            - name: Install Wrangler
              run: npm install -g wrangler

            # === Ê†∏ÂøÉ‰øÆÂ§çÔºöÂä®ÊÄÅÁéØÂ¢ÉÂèòÈáèÈÖçÁΩÆ ===
            # Ê†πÊçÆËß¶ÂèëÁ±ªÂûãÂíåËæìÂÖ•ÔºåÂÜ≥ÂÆö‰ΩøÁî®Âì™‰∏™ SecretÔºåÂπ∂ÂÜôÂÖ•ÁéØÂ¢ÉÂèòÈáè‰æõÂêéÁª≠Ê≠•È™§‰ΩøÁî®
            - name: Setup Environment Variables
              id: env_setup
              shell: bash
              run: |
                  set -euo pipefail
                  
                  # 1. Á°ÆÂÆöÁõÆÊ†áÁéØÂ¢É
                  if [[ "${{ github.event_name }}" == "schedule" ]]; then
                    TARGET_ENV="production"
                  else
                    TARGET_ENV="${{ inputs.environment }}"
                  fi
                  
                  echo "üöÄ Target Environment: $TARGET_ENV"
                  
                  # 2. Ê†πÊçÆÁéØÂ¢ÉËµãÂÄº Secret
                  if [[ "$TARGET_ENV" == "dev" ]]; then
                    echo "DB_ID=${{ secrets.D1_DATABASE_ID_DEV }}" >> $GITHUB_ENV
                    echo "WEBDAV_URL=${{ secrets.WEBDAV_URL_DEV }}" >> $GITHUB_ENV
                  else
                    echo "DB_ID=${{ secrets.D1_DATABASE_ID }}" >> $GITHUB_ENV
                    echo "WEBDAV_URL=${{ secrets.WEBDAV_URL }}" >> $GITHUB_ENV
                  fi
                  
                  # 3. ÈÄöÁî®ÂèòÈáè
                  echo "CLOUDFLARE_API_TOKEN=${{ secrets.CLOUDFLARE_API_TOKEN }}" >> $GITHUB_ENV
                  echo "CLOUDFLARE_ACCOUNT_ID=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" >> $GITHUB_ENV
                  echo "WEBDAV_USER=${{ secrets.WEBDAV_USER }}" >> $GITHUB_ENV
                  echo "WEBDAV_PASS=${{ secrets.WEBDAV_PASS }}" >> $GITHUB_ENV
                  echo "BACKUP_ENCRYPTION_KEY=${{ secrets.BACKUP_ENCRYPTION_KEY }}" >> $GITHUB_ENV

            - name: Get D1 Database Name
              id: db_name
              run: |
                  set -euo pipefail
                  
                  # ‰ΩøÁî®‰∏äÈù¢Ê≠•È™§ËÆæÁΩÆÁöÑ $DB_ID
                  echo "Looking for DB ID: $DB_ID"
                  
                  DB_NAME=$(npx wrangler d1 list --json | jq -r '.[] | select(.uuid == env.DB_ID) | .name')
                  
                  if [ -z "$DB_NAME" ]; then
                    echo "‚ùå Error: Could not find database with ID: $DB_ID"
                    exit 1
                  fi
                  
                  echo "‚úÖ Found database: $DB_NAME"
                  echo "db_name=$DB_NAME" >> $GITHUB_OUTPUT

            - name: Export D1 Database
              run: |
                  set -euo pipefail
                  
                  echo "üöÄ Exporting D1 database (${{ steps.db_name.outputs.db_name }})..."
                  npx wrangler d1 export "${{ steps.db_name.outputs.db_name }}" \
                    --remote \
                    --output=backup.sql
                  
                  gzip backup.sql
                  echo "üì¶ Backup compressed: backup.sql.gz"

            - name: Encrypt Backup (Optional)
              run: |
                  set -euo pipefail
                  
                  if [ -n "$BACKUP_ENCRYPTION_KEY" ]; then
                    echo "üîí Encrypting backup with AES-256..."
                    openssl enc -aes-256-cbc -salt -pbkdf2 -iter 100000 \
                      -in backup.sql.gz \
                      -out "warden-worker.sql.gz.enc" \
                      -pass pass:"$BACKUP_ENCRYPTION_KEY"
                    
                    rm backup.sql.gz
                    echo "‚úÖ Backup encrypted: warden-worker.sql.gz.enc"
                    echo "file_type=enc" >> $GITHUB_ENV
                  else
                    echo "‚ö†Ô∏è BACKUP_ENCRYPTION_KEY not set, skipping encryption"
                    mv backup.sql.gz "warden-worker.sql.gz"
                    echo "file_type=plain" >> $GITHUB_ENV
                  fi

            - name: Upload to WebDAV
              run: |
                  set -euo pipefail
                  
                  # 1. Á°ÆÂÆöË¶Å‰∏ä‰º†ÁöÑÊú¨Âú∞Êñá‰ª∂Âêç
                  if [ "$file_type" == "enc" ]; then
                    BACKUP_FILE="warden-worker.sql.gz.enc"
                  else
                    BACKUP_FILE="warden-worker.sql.gz"
                  fi

                  # 2. Êô∫ËÉΩËß£Êûê URL Ë∑ØÂæÑÈÄªËæë (ÈõÜÊàê‰πãÂâçÁöÑ‰ºòÂåñ)
                  if [[ "$WEBDAV_URL" == */ ]]; then
                    echo "üìÅ URL ends with '/': Treating as a directory path."
                    
                    DIR_URL="${WEBDAV_URL%/}"
                    UPLOAD_URL="${DIR_URL}/${BACKUP_FILE}"
                    
                    echo "üî® Checking/Creating directory: $DIR_URL"
                    
                    # Â∞ùËØïÂàõÂª∫ÁõÆÂΩï (MKCOL)
                    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X MKCOL \
                      --user "$WEBDAV_USER:$WEBDAV_PASS" \
                      "$DIR_URL")
                    
                    # 201=Created, 405=Method Not Allowed (exists), 409=Conflict (exists), 204/200=OK
                    if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 405 ] || [ "$HTTP_CODE" -eq 409 ] || [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 204 ]; then
                      echo "   ‚úÖ Directory verified/created."
                    else
                      echo "   ‚ùå Failed to create directory. HTTP Code: $HTTP_CODE"
                      echo "   Hint: Ensure parent directories exist if using nested paths."
                      exit 1
                    fi
                    
                  else
                    echo "üìÑ URL does NOT end with '/': Treating as a specific file path (overwrite mode)."
                    UPLOAD_URL="$WEBDAV_URL"
                  fi

                  echo "‚òÅÔ∏è Final Upload URL: $UPLOAD_URL"
                  
                  # 3. ÊâßË°å‰∏ä‰º†
                  curl -X PUT \
                    --user "$WEBDAV_USER:$WEBDAV_PASS" \
                    --upload-file "$BACKUP_FILE" \
                    --fail \
                    --show-error \
                    --retry 3 \
                    --retry-delay 5 \
                    --connect-timeout 10 \
                    "$UPLOAD_URL"
                  
                  echo "‚úÖ Backup uploaded successfully"
