name: Backup D1 Database to WebDAV

on:
    schedule:
        # Run daily at UTC 04:00
        - cron: "0 4 * * *"
    workflow_dispatch:
        inputs:
            environment:
                description: "Select the environment to backup"
                required: true
                default: "production"
                type: choice
                options:
                    - production
                    - dev

jobs:
    backup:
        name: Backup ${{ matrix.env_name }} D1 Database
        runs-on: ubuntu-latest
        # æ ¸å¿ƒé€»è¾‘ï¼šä½¿ç”¨çŸ©é˜µç­–ç•¥åŒºåˆ†ç¯å¢ƒï¼Œé¿å…é‡å¤ä»£ç 
        strategy:
            matrix:
                include:
                    - env_name: production
                      db_id_secret: D1_DATABASE_ID
                      webdav_url_secret: WEBDAV_URL
                      # åªæœ‰å®šæ—¶ä»»åŠ¡ä¸”æ˜¯productionï¼Œæˆ–è€…æ‰‹åŠ¨é€‰æ‹©äº†productionæ—¶æ‰è¿è¡Œ
                      run_condition: ${{ (github.event_name == 'schedule') || (github.event_name == 'workflow_dispatch' && inputs.environment == 'production') }}
                    
                    - env_name: dev
                      db_id_secret: D1_DATABASE_ID_DEV
                      webdav_url_secret: WEBDAV_URL_DEV
                      # åªæœ‰æ‰‹åŠ¨é€‰æ‹©äº†devæ—¶æ‰è¿è¡Œ
                      run_condition: ${{ github.event_name == 'workflow_dispatch' && inputs.environment == 'dev' }}

        # å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œç›´æ¥è·³è¿‡è¯¥çŸ©é˜µä»»åŠ¡
        if: matrix.run_condition == true

        steps:
            - name: Install Wrangler
              run: npm install -g wrangler

            - name: Get D1 Database Name
              id: db_name
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  # ä»çŸ©é˜µä¸­è·å–å¯¹åº”çš„ Secret å€¼
                  TARGET_DB_ID: ${{ secrets[matrix.db_id_secret] }}
              run: |
                  set -euo pipefail # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
                  
                  echo "Looking for DB ID: $TARGET_DB_ID"
                  DB_NAME=$(npx wrangler d1 list --json | jq -r '.[] | select(.uuid == env.TARGET_DB_ID) | .name')
                  
                  if [ -z "$DB_NAME" ]; then
                    echo "âŒ Error: Could not find database with ID: $TARGET_DB_ID"
                    exit 1
                  fi
                  
                  echo "âœ… Found database: $DB_NAME"
                  echo "db_name=$DB_NAME" >> $GITHUB_OUTPUT

            - name: Export D1 Database
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
              run: |
                  set -euo pipefail
                  
                  echo "ğŸš€ Exporting D1 database (${{ steps.db_name.outputs.db_name }})..."
                  npx wrangler d1 export "${{ steps.db_name.outputs.db_name }}" \
                    --remote \
                    --output=backup.sql
                  
                  # å‹ç¼©å¤‡ä»½æ–‡ä»¶
                  gzip backup.sql
                  echo "ğŸ“¦ Backup compressed: backup.sql.gz"

            - name: Encrypt Backup (Optional)
              env:
                  BACKUP_ENCRYPTION_KEY: ${{ secrets.BACKUP_ENCRYPTION_KEY }}
              run: |
                  set -euo pipefail
                  
                  if [ -n "$BACKUP_ENCRYPTION_KEY" ]; then
                    echo "ğŸ”’ Encrypting backup with AES-256..."
                    openssl enc -aes-256-cbc -salt -pbkdf2 -iter 100000 \
                      -in backup.sql.gz \
                      -out "warden-worker.sql.gz.enc" \
                      -pass pass:"$BACKUP_ENCRYPTION_KEY"
                    
                    # åˆ é™¤æœªåŠ å¯†æ–‡ä»¶
                    rm backup.sql.gz
                    echo "âœ… Backup encrypted: warden-worker.sql.gz.enc"
                    echo "file_type=enc" >> $GITHUB_ENV
                  else
                    echo "âš ï¸ BACKUP_ENCRYPTION_KEY not set, skipping encryption"
                    mv backup.sql.gz "warden-worker.sql.gz"
                    echo "file_type=plain" >> $GITHUB_ENV
                  fi

            - name: Upload to WebDAV
              env:
                  WEBDAV_URL: ${{ secrets[matrix.webdav_url_secret] }}
                  WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
                  WEBDAV_PASS: ${{ secrets.WEBDAV_PASS }}
              run: |
                  set -euo pipefail
                  
                  # æ ¹æ®ä¸Šä¸€æ­¥ç”Ÿæˆçš„ç¯å¢ƒå˜é‡å†³å®šä¸Šä¼ å“ªä¸ªæ–‡ä»¶
                  if [ "$file_type" == "enc" ]; then
                    BACKUP_FILE="warden-worker.sql.gz.enc"
                  else
                    BACKUP_FILE="warden-worker.sql.gz"
                  fi
                  
                  # è§„èŒƒåŒ– URL (å»é™¤æœ«å°¾æ–œæ )
                  UPLOAD_URL="${WEBDAV_URL%/}/$BACKUP_FILE"
                  
                  echo "â˜ï¸ Uploading backup to: $UPLOAD_URL"
                  
                  # ä½¿ç”¨ curl ä¸Šä¼ ï¼Œå¢åŠ  --retry å’Œ --connect-timeout æé«˜ç¨³å®šæ€§
                  curl -X PUT \
                    --user "$WEBDAV_USER:$WEBDAV_PASS" \
                    --upload-file "$BACKUP_FILE" \
                    --fail \
                    --show-error \
                    --retry 3 \
                    --retry-delay 5 \
                    --connect-timeout 10 \
                    "$UPLOAD_URL"
                  
                  echo "âœ… Backup uploaded successfully"
